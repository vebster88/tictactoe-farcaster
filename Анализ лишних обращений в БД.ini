Анализ лишних обращений в БД


1. Не принятые матчи удалять через 20 минут
2. Подумать как сократеть время до получения инфориации о старте матча
1. Частые SMEMBERS "match:pending"
Источник: api/matches/list.js → getAvailableMatches() → SMEMBERS "match:pending"
Проблемы:
Кеш в api/matches/list.js всего 2 секунды (CACHE_TTL_MS = 2000)
getAvailableMatches вызывается при каждом запросе списка матчей
В логах SMEMBERS каждые 3–5 секунд
Решение:
Увеличить CACHE_TTL_MS в api/matches/list.js до 10–15 секунд
Увеличить PENDING_CACHE_TTL_MS (уже 15000, но можно до 20–30 секунд)
2. Множественные GET match:* для одних и тех же матчей
В логах:
GET match:a6200c6d-... повторяется много раз (23:16:30, 23:16:41, 23:16:51, 23:17:07, 23:17:17, 23:17:34, 23:18:09, 23:18:25, 23:18:45, 23:19:06, 23:19:21, 23:19:30)
Причина:
getAvailableMatches делает GET match:* для каждого pending матча
Кеш матча (MATCH_CACHE_TTL_MS = 7000) может не срабатывать из-за разных инстансов/процессов
Решение:
Увеличить MATCH_CACHE_TTL_MS до 15–20 секунд
В getAvailableMatches использовать батчированный mget (если поддерживается)
3. Дублирующиеся SET match:* и SADD player_matches:*
В логах видно:
Один и тот же матч записывается несколько раз подряд:
23:15:11 — SET match:98989459...
23:15:17 — SET match:98989459... (тот же)
23:15:27 — SET match:98989459... (тот же)
Причина:
Idempotent-проверка в saveMatch сравнивает gameState через JSON.stringify, но updatedAt меняется каждый раз
Несколько инстансов/процессов могут обновлять один матч одновременно
Решение:
Улучшить idempotent-проверку: не считать updatedAt значимым изменением
Добавить проверку перед SADD player_matches:* — не добавлять, если уже есть
4. Лишние SADD player_matches:* при каждом обновлении матча
В логах:
При каждом SET match:* идут SADD player_matches:26081 и SADD player_matches:22575, даже если матч уже в индексе
Причина:
В saveMatch SADD вызывается всегда при hasSignificantChanges, без проверки наличия в индексе
Решение:
Проверять наличие матча в player_matches:* перед SADD (или использовать SADD как idempotent, но это все равно лишний запрос)
Рекомендации по оптимизации
Увеличить TTL кешей:
CACHE_TTL_MS в api/matches/list.js: 2000 → 10000–15000 мс
MATCH_CACHE_TTL_MS: 7000 → 15000–20000 мс
Улучшить idempotent-проверку в saveMatch:
Исключить updatedAt из сравнения
Проверять наличие в индексе перед SADD
Оптимизировать getAvailableMatches:
Использовать батчированный mget для получения матчей
Увеличить TTL кеша pending-списка
Убрать getAvailableMatches из api/matches/list.js:
Если пользователю не нужны чужие pending-матчи в его списке, можно убрать этот вызов
Переключись в agent mode, чтобы я мог внести эти изменения.